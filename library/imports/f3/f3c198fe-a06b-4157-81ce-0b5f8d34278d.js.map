{"version":3,"sources":["../../../../../../assets/script/modules/warehouse/assets/script/modules/warehouse/KnifeWarehousePageViewComponent.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"../../../../../../assets/script/modules/warehouse","sourcesContent":["import ResourceUtil from \"../../utils/ResourceUtil\";\nimport StorageUtils from \"../../utils/StorageUtils\"\nimport { Constants } from \"../../Constants\";\nimport ConfigUtil from \"../../utils/ConfigUtil\";\n\nconst { ccclass, property } = cc._decorator;\n\nexport const COUNT_KNIFES_ONE_PAGE = 7;\n\n@ccclass\nexport default class KnifeWarehousePageViewComponent extends cc.Component {\n\n    @property(cc.PageView)\n    pageView: cc.PageView = null;\n\n    @property(cc.Layout)\n    defeatBossLayout: cc.Layout = null;\n\n    @property(cc.Sprite)\n    preview: cc.Sprite = null;\n\n    @property(cc.Button)\n    equipButton: cc.Button = null;\n\n    @property(cc.AudioClip)\n    chooseKnifeAudio: cc.AudioClip = null;\n\n    private updateEquipButtonStatus: (index: number) => void;\n\n    private previewSprite: cc.Sprite;\n\n    private pageIndex: number = 0;\n    private offsetXToCenter: number = 0;\n\n    private touchStartPositionX: number = 0;\n    private hasScrolledToUserKnife: boolean = false;\n\n    onLoad() {\n        for (let index = 1; ConfigUtil.shared.hasKnife(ConfigUtil.shared.getKnifeId(index)); index++) {\n            let node = cc.instantiate(this.pageView.getPages()[0]);\n            let knifeSprite: cc.Sprite = node.getComponent(cc.Sprite);\n\n            ResourceUtil.loadSpriteRes(ConfigUtil.shared.getKnifeResourceUrl(ConfigUtil.shared.getKnifeId(index)), (error: Error, resource: cc.SpriteFrame) => {\n                knifeSprite.spriteFrame = resource;\n            });\n            this.pageView.addPage(node);\n        }\n\n        this.pageView.node.on(Constants.EVENT_PAGE_VIEW_SCROLL, this.onScroll);\n\n        this.pageView.node.on(cc.Node.EventType.TOUCH_START, this.onTouchStart);\n        this.pageView.node.on(cc.Node.EventType.TOUCH_END, this.onTouchEnd);\n\n        this.pageView.node.on(cc.Node.EventType.TOUCH_CANCEL, this.onTouchEnd);\n\n        this.previewSprite = this.preview.getComponent(cc.Sprite);\n\n        let userKnifeId: string = StorageUtils.shared.getString(Constants.KEY_USER_KNIFE, Constants.DEFAULT_USER_KNIFE_ID);\n        this.pageIndex = ConfigUtil.shared.getIndexFromKnifeId(userKnifeId);\n\n        ResourceUtil.loadSpriteRes(ConfigUtil.shared.getKnifeResourceUrl(ConfigUtil.shared.getKnifeId(this.pageIndex)), (error: Error, resource: cc.SpriteFrame) => {\n            this.pageView.getPages()[this.pageIndex].setScale(2);\n\n            this.previewSprite.spriteFrame = resource;\n        });\n    }\n\n    start() {\n    }\n\n    update(dt) {\n        if (!this.hasScrolledToUserKnife) {\n            let offset = new cc.Vec2(0, 0);\n            this.offsetXToCenter = (this.pageView.node.getChildByName(\"view\").getChildByName(\"content\")\n                .getComponent(cc.Layout).spacingX + this.pageView.getPages()[0].width) * (1 + COUNT_KNIFES_ONE_PAGE) / 2;\n\n            offset.x = this.pageView.getPages()[this.pageIndex].getPositionX() - this.offsetXToCenter;\n            offset.y = 0;\n            this.pageView.scrollToOffset(offset, 0.3);\n            this.hasScrolledToUserKnife = true;\n        }\n    }\n\n    public getCurrentKnifeId(): string {\n        return ConfigUtil.shared.getKnifeId(this.pageIndex);\n    }\n\n    private onScroll = (event: cc.Event): void => {\n        let scrollOffset = this.pageView.getScrollOffset().x;\n\n        let halfSelectionWidth = (this.pageView.node.getChildByName(\"view\").getChildByName(\"content\")\n            .getComponent(cc.Layout).spacingX + this.pageView.getPages()[0].width) / 2;\n\n        for (let index = 0; index < this.pageView.getPages().length; index++) {\n            let page = this.pageView.getPages()[index];\n\n            if (Math.abs(page.x + scrollOffset - this.offsetXToCenter) < halfSelectionWidth && this.pageIndex != index) {\n                this.changePageIndex(index);\n                this.updateEquipButtonStatus(index);\n            }\n        }\n\n        ResourceUtil.loadSpriteRes(ConfigUtil.shared.getKnifeResourceUrl(ConfigUtil.shared.getKnifeId(this.pageIndex)), (error: Error, resource: cc.SpriteFrame) => {\n            this.previewSprite.spriteFrame = resource;\n        });\n    }\n\n    private onTouchStart = (event: cc.Event.EventTouch): void => {\n        if (StorageUtils.shared.getBoolean(Constants.KEY_SOUND_SWITCH, true)) {\n            cc.audioEngine.playEffect(this.chooseKnifeAudio, false);\n        }\n\n        this.touchStartPositionX = event.touch.getLocationX();\n    }\n\n    private onTouchEnd = (event: cc.Event.EventTouch): void => {\n        if (Math.abs(event.touch.getLocationX() - this.touchStartPositionX) > 0.0001) {\n            this.scrollToKnife(this.pageIndex);\n            return;\n        }\n\n        let windowSize = cc.view.getVisibleSize();\n        let halfSelectionWidth = (this.pageView.node.getChildByName(\"view\").getChildByName(\"content\")\n            .getComponent(cc.Layout).spacingX + this.pageView.getPages()[0].width) / 2;\n        if (event.touch.getLocationX() > (windowSize.width / 2 + halfSelectionWidth)) {\n            this.scrollToKnife(this.pageIndex + 1, 0.1);\n            return;\n        }\n\n        if (event.touch.getLocationX() < (windowSize.width / 2 - halfSelectionWidth)) {\n            this.scrollToKnife(this.pageIndex - 1, 0.1);\n            return;\n        }\n\n        this.scrollToKnife(this.pageIndex, 0)\n    }\n\n    public scrollToKnife = (index: number, time?: number): void => {\n        if (index != null) {\n            this.changePageIndex(index);\n        }\n\n        let offset = new cc.Vec2(0, 0);\n        offset.x = this.pageView.getPages()[this.pageIndex].getPositionX() - this.offsetXToCenter;\n        this.pageView.scrollToOffset(offset, time == null? 0.3: time);\n    }\n\n    private changePageIndex(index) {\n        this.pageView.getPages()[this.pageIndex].setScale(1);\n        this.pageIndex = index;\n        this.pageView.getPages()[this.pageIndex].setScale(2);\n    }\n\n    public init(updateEquipButtonStatus: (index: number) => void): void {\n        this.updateEquipButtonStatus = updateEquipButtonStatus;\n    }\n\n}\n"]}