{"version":3,"sources":["GiftComponent.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"../../../../../assets/script/components","sourcesContent":["import StorageUtils from \"../utils/StorageUtils\";\nimport { Constants } from \"../Constants\";\nimport ApplePartsControlComponent from \"../components/ApplePartsControlComponent\";\n\nconst NODE_NAME_GIFT_COIN_COUNT = \"gift_coin_count\";\nconst NODE_NAME_GIFT_COIN_COUNT_CONTAINER = \"gift_coin_count_container\";\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class GiftComponent extends cc.Component {\n\n    @property(cc.Node)\n    giftMask: cc.Node = null;\n\n    @property(cc.Prefab)\n    applePartsPrefab: cc.Prefab = null;\n\n    @property(cc.Label)\n    timerLabel: cc.Label = null;\n\n    @property(cc.Label)\n    currencyLabel: cc.Label = null;\n\n    @property(cc.AudioClip)\n    giftOpenAudio: cc.AudioClip = null;\n\n    private giftApples: cc.Node[] = [];\n    private giftCountDown: number = Constants.GIFT_COUNTDOWN_TIME;\n    private isMaskShow: boolean = false;\n\n    onLoad() {\n        cc.log(\"GiftComponent onLoad\");\n\n        this.updateGiftCountdown();\n\n        this.node.on(cc.Node.EventType.TOUCH_END, () => {\n            if (this.giftCountDown <= 0) {\n                this.openGift(50 + Math.floor(Math.random() * 10));\n            }\n        }, this);\n    }\n\n    start() {\n    }\n\n    update(dt) {\n        this.updateGiftCountdown();\n    }\n\n    private transNumberToString(num: number): string {\n        return num < 10 ? \"0\" + num : String(num);\n    }\n\n    private openGift(coins: number) {\n        if (StorageUtils.shared.getBoolean(Constants.KEY_SOUND_SWITCH, true)) {\n            cc.audioEngine.playEffect(this.giftOpenAudio, false);\n        }\n\n        StorageUtils.shared.putInt(Constants.KEY_NEXT_GIFT_TIME, new Date().getTime() + Constants.GIFT_COUNTDOWN_TIME);\n        StorageUtils.shared.putInt(Constants.KEY_CURRENCY, StorageUtils.shared.getInt(Constants.KEY_CURRENCY, 0) + coins);\n        this.currencyLabel.getComponent(cc.Label).string = StorageUtils.shared.getString(Constants.KEY_CURRENCY, \"0\");\n\n        this.isMaskShow = true;\n        this.giftMask.opacity = 200;\n        this.giftMask.getChildByName(NODE_NAME_GIFT_COIN_COUNT_CONTAINER).getChildByName(NODE_NAME_GIFT_COIN_COUNT).getComponent(cc.Label).string = \"+\" + String(coins);\n        for (let i = 0; i < Constants.COUNT_GIFT_APPLES; i++) {\n            let applePartsNode = cc.instantiate(this.applePartsPrefab);\n\n            applePartsNode.setPosition(new cc.Vec2(Math.random() * 400 * (Math.random() > 0.5 ? 1 : -1) + 100,\n                Math.random() * 400 - 100));\n            this.giftMask.addChild(applePartsNode);\n            applePartsNode.getComponent(ApplePartsControlComponent).split();\n\n            this.giftApples.push(applePartsNode);\n            this.giftCountDown = Constants.GIFT_COUNTDOWN_TIME;\n        }\n\n        this.giftMask.on(cc.Node.EventType.TOUCH_END, () => {\n            this.closeGiftMask();\n        }, this);\n\n        this.scheduleOnce(() => {\n            this.closeGiftMask();\n        }, 2);\n    }\n\n    private updateGiftCountdown(): void {\n        let giftNextTime = StorageUtils.shared.getInt(Constants.KEY_NEXT_GIFT_TIME, 0);\n\n        this.giftCountDown = giftNextTime - new Date().getTime();\n        this.giftCountDown = Math.max(this.giftCountDown, 0);\n        this.giftCountDown = Math.min(this.giftCountDown, Constants.GIFT_COUNTDOWN_TIME);\n\n        if (giftNextTime == 0) {\n            StorageUtils.shared.putInt(Constants.KEY_NEXT_GIFT_TIME, new Date().getTime());\n            this.giftCountDown = 0;\n        }\n\n        if (this.giftCountDown <= 0) {\n            this.timerLabel.string = \"FREE GIFT\";\n            return;\n        }\n\n        this.timerLabel.getComponent(cc.Label).string = this.transNumberToString(Math.floor(this.giftCountDown / 60 / 1000 / 60)) + \":\" +\n            this.transNumberToString(Math.floor((this.giftCountDown % (60 * 1000 * 60) / 60 / 1000))) + \":\" +\n            this.transNumberToString(Math.floor((this.giftCountDown % (60 * 1000)) / 1000));\n    }\n\n    public isReady(): boolean {\n        return this.giftCountDown <= 0;\n    }\n\n    private closeGiftMask(): void {\n        if (this.isMaskShow) {\n            for (let i = 0; i < this.giftApples.length; i++) {\n                this.node.removeChild(this.giftApples[i]);\n            }\n\n            this.giftMask.opacity = 0;\n            this.isMaskShow = false;\n            this.giftMask.off(cc.Node.EventType.TOUCH_END);\n        }\n    }\n}\n"]}